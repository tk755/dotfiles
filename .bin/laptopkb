#!/usr/bin/env python3

import subprocess, re

def detect_olkb():
    """Returns whether an OLKB keyboard is connected to the computer.
    Requires: xinput, grep, wc."""
    proc1 = subprocess.Popen(['xinput', 'list'], stdout=subprocess.PIPE)
    proc2 = subprocess.Popen(['grep', 'OLKB'], stdin=proc1.stdout, stdout=subprocess.PIPE)
    proc3 = subprocess.Popen(['wc', '-l'], stdin=proc2.stdout, stdout=subprocess.PIPE)
    stdout, stderr = proc3.communicate()

    return not int(stdout) == 0

def laptopkb_id():
    """Returns the xinput id of the laptop keyboard"""
    proc = subprocess.Popen(['xinput', 'list'], text=True, stdout=subprocess.PIPE)
    stdout, stderr = proc.communicate()

    identifiers = ['Apple Internal Keyboard', 'AT Translated Set']
    pattern = '.*(' + '|'.join(identifiers) + ').*id=([\d]*).*'

    match = re.search(pattern, stdout, re.IGNORECASE)
    return match.group(2)

def disable_laptopkb():
    proc = subprocess.Popen(['xinput', 'float', laptopkb_id()])

def enable_laptopkb():
    proc = subprocess.Popen(['xinput', 'reattach', laptopkb_id(), '3'])

if __name__ == '__main__':
    if detect_olkb():
        disable_laptopkb()
        print('olkb detected - laptop keyboard DISABLED')
    else:
        enable_laptopkb()
        print('olkb not detected - laptop keyboard ENABLED')
